{% extends 'base.html' %}
{% load static %}

{% block title %}Change Password - Style Ghor{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-key me-2"></i>Change Password
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" id="changePasswordForm">
                        {% csrf_token %}
                        
                        <!-- Current Password -->
                        <div class="mb-3">
                            <label for="id_current_password" class="form-label">Current Password</label>
                            <div class="input-group">
                                <input type="password" name="current_password" class="form-control" id="id_current_password" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('id_current_password')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- New Password -->
                        <div class="mb-3">
                            <label for="id_new_password1" class="form-label">New Password</label>
                            <div class="input-group">
                                <input type="password" name="new_password1" class="form-control" id="id_new_password1" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('id_new_password1')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="password-strength mt-2" id="passwordStrength"></div>
                        </div>
                        
                        <!-- Confirm New Password -->
                        <div class="mb-4">
                            <label for="id_new_password2" class="form-label">Confirm New Password</label>
                            <div class="input-group">
                                <input type="password" name="new_password2" class="form-control" id="id_new_password2" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('id_new_password2')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="password-match mt-2" id="passwordMatch"></div>
                        </div>
                        
                        <!-- Password Requirements -->
                        <div class="password-requirements mb-4">
                            <h6 class="mb-2">Password Requirements:</h6>
                            <ul class="list-unstyled small">
                                <li id="req_length"><i class="fas fa-circle text-muted me-2"></i>At least 8 characters long</li>
                                <li id="req_uppercase"><i class="fas fa-circle text-muted me-2"></i>Contains uppercase letter</li>
                                <li id="req_lowercase"><i class="fas fa-circle text-muted me-2"></i>Contains lowercase letter</li>
                                <li id="req_number"><i class="fas fa-circle text-muted me-2"></i>Contains number</li>
                                <li id="req_special"><i class="fas fa-circle text-muted me-2"></i>Contains special character</li>
                            </ul>
                        </div>
                        
                        <!-- Submit Buttons -->
                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save me-2"></i>Change Password
                            </button>
                            <a href="{% url 'users:profile' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Security Tips -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Security Tips
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Use a unique password that you don't use elsewhere</li>
                        <li>Consider using a password manager for better security</li>
                        <li>Never share your password with anyone</li>
                        <li>Change your password regularly</li>
                        <li>Use two-factor authentication if available</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.password-strength {
    height: 20px;
    border-radius: 10px;
    background-color: #f8f9fa;
    overflow: hidden;
}

.password-strength::before {
    content: '';
    display: block;
    height: 100%;
    width: 0%;
    transition: width 0.3s ease, background-color 0.3s ease;
}

.password-strength.weak::before {
    width: 25%;
    background-color: #dc3545;
}

.password-strength.fair::before {
    width: 50%;
    background-color: #ffc107;
}

.password-strength.good::before {
    width: 75%;
    background-color: #17a2b8;
}

.password-strength.strong::before {
    width: 100%;
    background-color: #28a745;
}

.password-match {
    font-size: 0.875rem;
}

.password-match.match {
    color: #28a745;
}

.password-match.no-match {
    color: #dc3545;
}

.password-requirements li {
    margin-bottom: 0.25rem;
}

.password-requirements li.valid i {
    color: #28a745;
}

.password-requirements li.invalid i {
    color: #dc3545;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Password strength checker
    $('#id_new_password1').on('input', function() {
        const password = $(this).val();
        checkPasswordStrength(password);
        checkPasswordRequirements(password);
    });
    
    // Password confirmation checker
    $('#id_new_password2').on('input', function() {
        const password1 = $('#id_new_password1').val();
        const password2 = $(this).val();
        checkPasswordMatch(password1, password2);
    });
    
    // Form submission
    $('#changePasswordForm').submit(function(e) {
        if (!validateForm()) {
            e.preventDefault();
            return false;
        }
    });
});

function togglePassword(inputId) {
    const input = $(`#${inputId}`);
    const button = input.next('.btn');
    const icon = button.find('i');
    
    if (input.attr('type') === 'password') {
        input.attr('type', 'text');
        icon.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
        input.attr('type', 'password');
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
    }
}

function checkPasswordStrength(password) {
    const strength = calculatePasswordStrength(password);
    const strengthBar = $('#passwordStrength');
    
    strengthBar.removeClass('weak fair good strong');
    strengthBar.addClass(strength.class);
    
    // Update text
    strengthBar.text(strength.text);
}

function calculatePasswordStrength(password) {
    let score = 0;
    
    if (password.length >= 8) score++;
    if (/[A-Z]/.test(password)) score++;
    if (/[a-z]/.test(password)) score++;
    if (/[0-9]/.test(password)) score++;
    if (/[^A-Za-z0-9]/.test(password)) score++;
    
    if (score <= 1) return { class: 'weak', text: 'Weak' };
    if (score <= 2) return { class: 'fair', text: 'Fair' };
    if (score <= 3) return { class: 'good', text: 'Good' };
    return { class: 'strong', text: 'Strong' };
}

function checkPasswordRequirements(password) {
    const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[^A-Za-z0-9]/.test(password)
    };
    
    Object.keys(requirements).forEach(req => {
        const element = $(`#req_${req}`);
        if (requirements[req]) {
            element.addClass('valid').removeClass('invalid');
            element.find('i').removeClass('fa-circle text-muted').addClass('fa-check text-success');
        } else {
            element.addClass('invalid').removeClass('valid');
            element.find('i').removeClass('fa-check text-success').addClass('fa-circle text-muted');
        }
    });
}

function checkPasswordMatch(password1, password2) {
    const matchElement = $('#passwordMatch');
    
    if (password2 === '') {
        matchElement.removeClass('match no-match').text('');
    } else if (password1 === password2) {
        matchElement.removeClass('no-match').addClass('match').text('Passwords match');
    } else {
        matchElement.removeClass('match').addClass('no-match').text('Passwords do not match');
    }
}

function validateForm() {
    let isValid = true;
    
    // Check current password
    const currentPassword = $('#id_current_password').val().trim();
    if (!currentPassword) {
        showAlert('Please enter your current password', 'error');
        isValid = false;
    }
    
    // Check new password
    const newPassword1 = $('#id_new_password1').val().trim();
    if (!newPassword1) {
        showAlert('Please enter a new password', 'error');
        isValid = false;
    }
    
    // Check password confirmation
    const newPassword2 = $('#id_new_password2').val().trim();
    if (!newPassword2) {
        showAlert('Please confirm your new password', 'error');
        isValid = false;
    }
    
    if (newPassword1 !== newPassword2) {
        showAlert('New passwords do not match', 'error');
        isValid = false;
    }
    
    // Check password strength
    const strength = calculatePasswordStrength(newPassword1);
    if (strength.class === 'weak') {
        showAlert('Please choose a stronger password', 'warning');
        isValid = false;
    }
    
    return isValid;
}

function showAlert(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Remove existing alerts
    $('.alert').remove();
    
    // Add new alert
    $('.card-body').first().prepend(alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        $('.alert').fadeOut(300, function() {
            $(this).remove();
        });
    }, 5000);
}
</script>
{% endblock %}